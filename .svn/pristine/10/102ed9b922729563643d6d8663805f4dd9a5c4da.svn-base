@model IEnumerable<SAMLitigation.Models.ViewModel.SAM_Litigation_DetailsViewModel>

@{
    ViewData["Title"] = "Litigation Details";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2>
                <i class="fas fa-gavel"></i> SAM Litigation Details
            </h2>
            <hr />
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12 text-right">
            <button type="button" class="btn btn-primary" onclick="handleAddDocument()">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Litigation Actions List</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th width="12%">Action Name</th>
                                    <th width="10%">Case Number</th>
                                    <th width="12%">Court Name</th>
                                    <th width="12%">Lawyer Name</th>
                                    <th width="10%">Action Date</th>
                                    <th width="9%">Post Comments</th>
                                    <th width="9%">Prior Comments</th>
                                    <th width="8%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    @switch (item.PartialViewNumber)
                                    {
                                        case 1:
                                            @await Html.PartialAsync("_SuitFillingIdcolReceivePartialView", item)
                                            break;
                                        case 2:
                                            @await Html.PartialAsync("_SuitFillingReportedToBangladeshBankPartialView", item)
                                            break;
                                        case 3:
                                            @await Html.PartialAsync("_HearingPartialView", item)
                                            break;
                                        case 4:
                                            @await Html.PartialAsync("_DiscussionArgumentPartialView", item)
                                            break;
                                        case 5:
                                            @await Html.PartialAsync("_SuitDismissalPartialView", item)
                                            break;
                                        default:
                                            <tr class="default-row">
                                                <td colspan="10" class="text-center text-muted">
                                                    <em>Unknown Category (PartialViewNumber: @item.PartialViewNumber)</em>
                                                </td>
                                            </tr>
                                            break;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="fas fa-edit"></i> Edit Litigation Detail
                </h5>
            </div>
            <div class="modal-body">
                <form id="editDetailsForm">
                    <input type="hidden" id="edit_litigationDetailID" />
                    <input type="hidden" id="edit_litigationID" />
                    <input type="hidden" id="edit_makerUserID" value="1" />
                    <input type="hidden" id="edit_checkerUserID" value="1" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_litigationActionID">Litigation Action <span class="text-danger">*</span></label>
                                <select id="edit_litigationActionID" class="form-control" required>
                                    <option value="">-- Select Action --</option>
                                    @if (ViewBag.ListActions != null)
                                    {
                                        @foreach (var action in ViewBag.ListActions)
                                        {
                                            <option value="@action.Value">@action.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_actionTakenDate">Action Date <span class="text-danger">*</span></label>
                                <input type="date" id="edit_actionTakenDate" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_caseNumber">Case Number <span class="text-danger">*</span></label>
                                <input type="text" id="edit_caseNumber" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_litigationCourtID">Court Name <span class="text-danger">*</span></label>
                                <select id="edit_litigationCourtID" class="form-control" required>
                                    <option value="">-- Select Court --</option>
                                    @if (ViewBag.ListCourts != null)
                                    {
                                        @foreach (var court in ViewBag.ListCourts)
                                        {
                                            <option value="@court.Value">@court.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_litigationLawyerID">Lawyer Name <span class="text-danger">*</span></label>
                                <select id="edit_litigationLawyerID" class="form-control" required>
                                    <option value="">-- Select Lawyer --</option>
                                    @if (ViewBag.ListLawyers != null)
                                    {
                                        @foreach (var lawyer in ViewBag.ListLawyers)
                                        {
                                            <option value="@lawyer.Value">@lawyer.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_commentsPriorAction">Comments Prior Action</label>
                                <textarea id="edit_commentsPriorAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_commentsPostAction">Comments Post Action</label>
                                <textarea id="edit_commentsPostAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-warning" onclick="handleSaveChanges()">
                    <i class="fas fa-save"></i> Update
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addModalLabel">
                    <i class="fas fa-plus-circle"></i> Add Litigation Detail
                </h5>
            </div>
            <div class="modal-body">
                <form id="addDetailsForm">
                    <input type="hidden" id="litigationID" value="@ViewBag.LitigationId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="litigationActionID">Litigation Action <span class="text-danger">*</span></label>
                                <select id="litigationActionID" class="form-control" required>
                                    <option value="">-- Select Action --</option>
                                    @if (ViewBag.ListActions != null)
                                    {
                                        @foreach (var action in ViewBag.ListActions)
                                        {
                                            <option value="@action.Value">@action.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionTakenDate">Action Date <span class="text-danger">*</span></label>
                                <input type="date" id="actionTakenDate" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="caseNumber">Case Number <span class="text-danger">*</span></label>
                                <input type="text" id="caseNumber" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="litigationCourtID">Court Name <span class="text-danger">*</span></label>
                                <select id="litigationCourtID" class="form-control" required>
                                    <option value="">-- Select Court --</option>
                                    @if (ViewBag.ListCourts != null)
                                    {
                                        @foreach (var court in ViewBag.ListCourts)
                                        {
                                            <option value="@court.Value">@court.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="litigationLawyerID">Lawyer Name <span class="text-danger">*</span></label>
                                <select id="litigationLawyerID" class="form-control" required>
                                    <option value="">-- Select Lawyer --</option>
                                    @if (ViewBag.ListLawyers != null)
                                    {
                                        @foreach (var lawyer in ViewBag.ListLawyers)
                                        {
                                            <option value="@lawyer.Value">@lawyer.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="commentsPriorAction">Comments Prior Action</label>
                                <textarea id="commentsPriorAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="commentsPostAction">Comments Post Action</label>
                                <textarea id="commentsPostAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseAddModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="handleSaveNewDetail()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table-responsive {
        max-height: 650px;
        overflow-y: auto;
    }

    thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #343a40 !important;
        color: white !important;
    }

    .default-row {
        background-color: #f5f5f5;
    }

    .badge-lg {
        font-size: 0.95em;
    }
</style>


@section Scripts {
    <script>
        // Get the litigation ID from ViewBag
        var currentLitigationID = @(ViewBag.LitigationId ?? 0);

        // Function to open Add modal
        function handleAddDocument() {
            // Reset the form
            $('#addDetailsForm')[0].reset();
            // Set the litigation ID (it's already in the hidden field from the page load)
            $('#litigationID').val(currentLitigationID);
            // Show the modal
            $('#addModal').modal('show');
        }

        // Function to save new detail
        function handleSaveNewDetail() {
            // Validate the form
            if (!$('#addDetailsForm')[0].checkValidity()) {
                $('#addDetailsForm')[0].reportValidity();
                return;
            }

            var formData = {
                litigationID: parseFloat($('#litigationID').val()),
                litigationActionID: parseFloat($('#litigationActionID').val()),
                actionTakenDate: $('#actionTakenDate').val(),
                caseNumber: $('#caseNumber').val(),
                commentsPriorAction: $('#commentsPriorAction').val(),
                commentsPostAction: $('#commentsPostAction').val(),
                litigationCourtID: parseFloat($('#litigationCourtID').val()),
                litigationLawyerID: parseFloat($('#litigationLawyerID').val()),
                makerUserID: 1, // Default value Login Value
                checkerUserID: 1 // Default value Login Value
            };

            console.log('Adding detail:', formData);

            $.ajax({
                url: '@Url.Action("AddDetails", "SAM_Litigation_Details")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Add response:', response);
                    if (response.success) {
                        alert(response.message);
                        $('#addModal').modal('hide');
                        // Reload with the litigation ID parameter
                        window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + currentLitigationID;
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Add error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }

        // Function to close Add modal
        function handleCloseAddModal() {
            $('#addModal').modal('hide');
        }

        // Function to handle editing a litigation detail
        function handleEditDetail(detailId) {
            console.log('Editing detail ID:', detailId);

            $.ajax({
                url: '@Url.Action("GetDetailById", "SAM_Litigation_Details")',
                type: 'GET',
                data: { id: detailId },
                success: function(response) {
                    console.log('Get response:', response);

                    // Check if response has success property and it's false (error response)
                    if (response.success === false) {
                        alert(response.message || 'Failed to load detail data');
                        return;
                    }

                    // Check if we have the required data
                    if (response.success === true && response.litigationDetailID) {
                        populateEditForm(response);
                        $('#editModal').modal('show');
                    } else {
                        alert('Invalid data received from server');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    alert('An error occurred while loading data: ' + error);
                }
            });
        }

        // Function to populate the edit form with data
        function populateEditForm(data) {
            console.log('Populating form with:', data);
            $('#edit_litigationDetailID').val(data.litigationDetailID);
            $('#edit_litigationID').val(data.litigationID);
            $('#edit_actionTakenDate').val(data.actionTakenDate);
            $('#edit_caseNumber').val(data.caseNumber);
            $('#edit_commentsPriorAction').val(data.commentsPriorAction || '');
            $('#edit_commentsPostAction').val(data.commentsPostAction || '');

            // Set Action dropdown by matching text
            $('#edit_litigationActionID option').filter(function() {
                return $(this).text() === data.litigationActionName;
            }).prop('selected', true);

            // Set Court dropdown by matching text
            $('#edit_litigationCourtID option').filter(function() {
                return $(this).text() === data.courtName;
            }).prop('selected', true);

            // Set Lawyer dropdown by matching text
            $('#edit_litigationLawyerID option').filter(function() {
                return $(this).text() === data.lawyerName;
            }).prop('selected', true);

            $('#edit_makerUserID').val(1); // Default value - adjust as needed
            $('#edit_checkerUserID').val(1); // Default value - adjust as needed
        }

        // Function to handle saving changes to a litigation detail
        function handleSaveChanges() {
            // Validate the form
            if (!$('#editDetailsForm')[0].checkValidity()) {
                $('#editDetailsForm')[0].reportValidity();
                return;
            }

            var formData = {
                litigationDetailID: parseFloat($('#edit_litigationDetailID').val()),
                litigationID: parseFloat($('#edit_litigationID').val()),
                litigationActionID: parseFloat($('#edit_litigationActionID').val()),
                actionTakenDate: $('#edit_actionTakenDate').val(),
                caseNumber: $('#edit_caseNumber').val(),
                commentsPriorAction: $('#edit_commentsPriorAction').val(),
                commentsPostAction: $('#edit_commentsPostAction').val(),
                litigationCourtID: parseFloat($('#edit_litigationCourtID').val()),
                litigationLawyerID: parseFloat($('#edit_litigationLawyerID').val()),
                makerUserID: parseFloat($('#edit_makerUserID').val()),
                checkerUserID: parseFloat($('#edit_checkerUserID').val())
            };

            console.log('Updating detail:', formData);

            $.ajax({
                url: '@Url.Action("UpdateDetails", "SAM_Litigation_Details")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Update response:', response);
                    if (response.success) {
                        alert(response.message);
                        $('#editModal').modal('hide');
                        // Reload with the litigation ID parameter
                        window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + currentLitigationID;
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Update Error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }

        // Function to handle closing the modal
        function handleCloseModal() {
            $('#editModal').modal('hide');
        }

        function viewDocument(LitigationDetailID) {
            if(!LitigationDetailID) {
                alert("Invalid Record ID");
                return;
            }
            window.location.href = '@Url.Action("Index", "SAM_Litigation_Detail_DocumentList")' + '?id=' + LitigationDetailID;
        }
    </script>
}