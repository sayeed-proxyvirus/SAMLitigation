using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using SAMLitigation.Models;
using SAMLitigation.Models.ApplicationDbContext;
using SAMLitigation.Models.ViewModel;
using System.Net.Http;

namespace SAMLitigation.Services.ServiceImple
{
    public class UserTableServiceImple : UserTableService
    {
        private readonly SAMDbContext _context;
        private readonly HttpClient _httpClient;

      

        public UserTableServiceImple(SAMDbContext context, HttpClient httpClient)
        {
            _context = context;
            _httpClient = httpClient;
        }

        public UserTable GetUserByUsername(string username)
        {
            try
            {
                SqlParameter paramUserName = new SqlParameter("@UserName", username);

                var userTable = _context.UsersTable
                                    .FromSqlRaw("EXEC GetUserByUserName @UserName", paramUserName)
                                    .AsEnumerable()
                                    .FirstOrDefault();
                return userTable;
            }
            catch
            {
                throw;
            }
        }

        public List<UserRoleRelationViewModel> GetUserRoleByUserId(decimal UserId)
        {
            try
            {
                SqlParameter paramUserId = new SqlParameter("@UserId", UserId);

                var userRoles = _context.Set<UserRoleRelationViewModel>()
                             .FromSqlRaw("EXEC Projects_Processflow_GetUserRoleByUserID @UserId", paramUserId)
                             .ToList();
                return userRoles;
            }
            catch
            {
                throw;
            }
        }

        public List<UserRoleRelationViewModel> GetUserRolesByUserName(string Username)
        {
            try 
            {
                string url = $"http://172.16.0.180:8040/api/auth/userRoles?username={Username}";

                // Set headers
                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("X-API-KEY", "MNReJOAXZ15424352552AXY}{*A[[[;;;;]]]OP@_$!bvcderAOPQASD");
                _httpClient.DefaultRequestHeaders.Add("Accept", "application/json");

                // Send GET request synchronously
                var response = _httpClient.GetAsync(url).Result;

                // API request failed (500/404/etc)
                if (!response.IsSuccessStatusCode)
                    return null;

                // Read response content synchronously
                var json = response.Content.ReadAsStringAsync().GetAwaiter().GetResult();

                // Deserialize JSON into List<UserRoleRelationViewModel>
                var roles = JsonConvert.DeserializeObject<List<UserRoleRelationViewModel>>(json);

                return roles;
            }
            catch
            {
                throw;
            }
        }

        public bool ValidateUser(string username, string password)
        {
            try
            {
                SqlParameter paramUserName = new SqlParameter("@UserName", username);
                SqlParameter paramPassword = new SqlParameter("@Password", password);


                var result = _context.UsersTable
                            .FromSqlRaw("EXEC ValidateUser @UserName, @Password", paramUserName, paramPassword)
                            .AsEnumerable()
                            .FirstOrDefault();

                return result != null;


            }
            catch
            {
                throw;
            }
        }
    }
}
