using Microsoft.AspNetCore.Mvc;
using SAMLitigation.Models;
using SAMLitigation.Services;

namespace SAMLitigation.Controllers
{
    public class SAM_Litigation_Detail_DocumentListController : Controller
    {
        private readonly ILogger<SAM_Litigation_Detail_DocumentListController> _logger;
        private readonly LitigationDetailDocumentListService _litigationDetailDocumentListService;

        public SAM_Litigation_Detail_DocumentListController(
            ILogger<SAM_Litigation_Detail_DocumentListController> logger,
            LitigationDetailDocumentListService litigationDetailDocumentListService)
        {
            _logger = logger;
            _litigationDetailDocumentListService = litigationDetailDocumentListService;
        }

        [HttpGet]
        public IActionResult Index(decimal Id)
        {
            try
            {
                _logger.LogInformation($"Loading documents for LitigationDetailID: {Id}");
                ViewBag.LitigationDetailID = Id;

                // Get ALL documents for this LitigationDetailID
                var detailDocs = _litigationDetailDocumentListService.GetAllDocumentsByLitigationDetailId(Id);

                if (detailDocs == null || !detailDocs.Any())
                {
                    _logger.LogWarning($"No documents found for LitigationDetailID {Id}");
                    return View(new List<SAM_Litigation_Detail_DocumentList>());
                }

                _logger.LogInformation($"Found {detailDocs.Count} documents for LitigationDetailID {Id}");
                return View(detailDocs);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in Index: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                ViewBag.LitigationDetailID = Id;
                return View(new List<SAM_Litigation_Detail_DocumentList>());
            }
        }

        [HttpPost]
        public IActionResult AddDetails(decimal litigationDetailID, string documentName, string documentLink)
        {
            try
            {
                _logger.LogInformation($"Adding document for LitigationDetailID: {litigationDetailID}");

                var DetailDocs = new SAM_Litigation_Detail_DocumentList
                {
                    LitigationDetailID = litigationDetailID,
                    DocumentName = documentName,
                    DocumentLink = documentLink,
                    CreatedBy = "System" // TODO: Replace with actual logged-in user
                };

                bool success = _litigationDetailDocumentListService.Add(DetailDocs);
                if (success)
                {
                    _logger.LogInformation($"Document added successfully for LitigationDetailID: {litigationDetailID}");
                    return Json(new
                    {
                        success = true,
                        message = "Document has been added successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning("Document addition failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to add document. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in AddDetails: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpPost]
        public IActionResult UpdateDetails(decimal documentListID, decimal litigationDetailID,
            string documentName, string documentLink)
        {
            try
            {
                _logger.LogInformation($"Updating document with ID: {documentListID}");

                var existingDetailDoc = _litigationDetailDocumentListService.GetDetailDocumentListByIdForUpdate(documentListID);
                if (existingDetailDoc == null)
                {
                    _logger.LogWarning($"Document with ID {documentListID} not found");
                    return Json(new
                    {
                        success = false,
                        message = "Document not found."
                    });
                }

                existingDetailDoc.LitigationDetailID = litigationDetailID;
                existingDetailDoc.DocumentName = documentName;
                existingDetailDoc.DocumentLink = documentLink;
                existingDetailDoc.CreatedBy = "System"; // TODO: Should be ModifiedBy

                bool success = _litigationDetailDocumentListService.Update(existingDetailDoc);
                if (success)
                {
                    _logger.LogInformation($"Document {documentListID} updated successfully");
                    return Json(new
                    {
                        success = true,
                        message = "Document has been updated successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning("Document update failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to update document. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in UpdateDetails: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpGet]
        public IActionResult GetDetailDocById(decimal id)
        {
            try
            {
                _logger.LogInformation($"Fetching document with DocumentListID: {id}");

                var detail = _litigationDetailDocumentListService.GetDetailDocumentListByIdForUpdate(id);

                if (detail == null)
                {
                    _logger.LogWarning($"Document with ID {id} not found");
                    return Json(new
                    {
                        success = false,
                        message = "Document not found."
                    });
                }

                _logger.LogInformation($"Document with ID {id} retrieved successfully");

                return Json(new
                {
                    success = true,
                    documentListID = detail.DocumentListID,
                    litigationDetailID = detail.LitigationDetailID,
                    documentName = detail.DocumentName ?? string.Empty,
                    documentLink = detail.DocumentLink ?? string.Empty
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in GetDetailDocById: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }
    }
}