using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using SAMLitigation.Models;
using SAMLitigation.Models.ViewModel;
using SAMLitigation.Services;

namespace SAMLitigation.Controllers
{
    public class SAM_Litigation_DetailsController : Controller
    {

        private readonly ILogger<SAM_Litigation_DetailsController> _logger;
        private readonly LitigationDetailService _litigationDetailService;
        private readonly CourtService _courtService;
        private readonly LawyerService _lawyerService;
        private readonly LitigationActionService _litigationActionService;

        public SAM_Litigation_DetailsController(ILogger<SAM_Litigation_DetailsController> logger,
            LitigationDetailService litigationDetailService, CourtService courtService,
            LawyerService lawyerService, LitigationActionService litigationActionService)
        {
            _logger = logger;
            _litigationDetailService = litigationDetailService;
            _courtService = courtService;
            _lawyerService = lawyerService;
            _litigationActionService = litigationActionService;
        }

        [HttpGet]
        public IActionResult Index()

        {
            try
            {
                List<SAM_Litigation_DetailsViewModel> ListDetails = _litigationDetailService.GetDetailsALLEx();
                List<SAM_Litigation_Court> ListCourt = _courtService.GetCourtALL();
                ViewBag.ListCourts = ListCourt.Select(x => new SelectListItem
                {
                    Value = x.LitigationCourtID.ToString(),
                    Text = x.CourtName
                }).ToList() ?? new List<SelectListItem>();

                List<SAM_Litigation_Lawyer> ListLawyer = _lawyerService.GetLawyerALL();
                ViewBag.ListLawyers = ListLawyer.Select(x => new SelectListItem
                {
                    Value = x.LitigationLawyerID.ToString(),
                    Text = x.LawyerName
                }).ToList() ?? new List<SelectListItem>();

                List<SAM_Litigation_Action> ListAction = _litigationActionService.GetActionALL();
                ViewBag.ListActions = ListAction.Select(x => new SelectListItem
                {
                    Value = x.LitigationActionID.ToString(),
                    Text = x.LitigationActionName
                }).ToList() ?? new List<SelectListItem>();

                return View(ListDetails);
            }
            catch (Exception)
            {
                throw;
            }
        }

        [HttpPost]
        public IActionResult AddDetails(decimal litigationID, decimal litigationActionID,
            DateTime actionTakenDate, string caseNumber, string commentsPriorAction,
            string commentsPostAction, decimal litigationCourtID, decimal litigationLawyerID,
            decimal makerUserID, decimal checkerUserID)
        {
            try
            {
                var Details = new SAM_Litigation_Detail
                {
                    LitigationID = litigationID,
                    LitigationActionID = litigationActionID,
                    ActionTakenDate = actionTakenDate,
                    CommentsPriorAction = commentsPriorAction,
                    CommentsPostAction = commentsPostAction,
                    CaseNumber = caseNumber,
                    CheckerUserID = checkerUserID,
                    MakerUserID = makerUserID,
                    LitigationCourtID = litigationCourtID,
                    LitigationLawyerID = litigationLawyerID
                };

                bool success = _litigationDetailService.Add(Details);
                if (success)
                {
                    _logger.LogInformation("Litigation Info is added successfully");
                    return Json(new
                    {
                        success = true,
                        message = $"Litigation Info of '{litigationID}' has been added successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning("Litigation Info data addition has been failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to add Litigation Info. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in Add: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpPost]
        public IActionResult UpdateDetails(decimal LitigationDetailID, decimal litigationID,
            decimal litigationActionID, DateTime actionTakenDate, string caseNumber,
            string commentsPriorAction, string commentsPostAction, decimal litigationCourtID,
            decimal litigationLawyerID, decimal makerUserID, decimal checkerUserID)
        {
            try
            {
                var existingDetail = _litigationDetailService.GetDetailByIdForUpdate(LitigationDetailID);
                if (existingDetail == null)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Detail Info not found."
                    });
                }

                existingDetail.LitigationID = litigationID;
                existingDetail.LitigationActionID = litigationActionID;
                existingDetail.ActionTakenDate = actionTakenDate;
                existingDetail.CaseNumber = caseNumber;
                existingDetail.CommentsPostAction = commentsPostAction;
                existingDetail.CommentsPriorAction = commentsPriorAction;
                existingDetail.LitigationCourtID = litigationCourtID;
                existingDetail.LitigationLawyerID = litigationLawyerID;
                existingDetail.CheckerUserID = checkerUserID;
                existingDetail.MakerUserID = makerUserID;

                bool success = _litigationDetailService.Update(existingDetail);
                if (success)
                {
                    _logger.LogInformation("Litigation Info is updated successfully");
                    return Json(new
                    {
                        success = true,
                        message = $"Litigation Info of '{litigationID}' has been updated successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning("Litigation Info data Update has been failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to update Litigation Info. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in Update: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpGet]
        public IActionResult GetDetailById(decimal id)
        {
            try
            {
                _logger.LogInformation($"Fetching detail with ID: {id}");

                var detail = _litigationDetailService.GetDetailById(id);

                if (detail == null)
                {
                    _logger.LogWarning($"Detail with ID {id} not found");
                    return Json(new
                    {
                        success = false,
                        message = "Detail Info not found."
                    });
                }

                _logger.LogInformation($"Detail with ID {id} retrieved successfully");

                // Return the detail data as JSON - ViewModel has names, not IDs
                return Json(new
                {
                    success = true,
                    litigationDetailID = detail.LitigationDetailID,
                    litigationID = detail.LitigationID,
                    litigationActionName = detail.LitigationActionName ?? string.Empty,
                    actionTakenDate = detail.ActionTakenDate.ToString("yyyy-MM-dd"),
                    caseNumber = detail.CaseNumber ?? string.Empty,
                    commentsPriorAction = detail.CommentsPriorAction ?? string.Empty,
                    commentsPostAction = detail.CommentsPostAction ?? string.Empty,
                    courtName = detail.CourtName ?? string.Empty,
                    lawyerName = detail.LawyerName ?? string.Empty
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in GetDetailById: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }
    }
}