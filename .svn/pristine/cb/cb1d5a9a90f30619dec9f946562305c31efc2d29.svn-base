// Services/ServiceImple/MenuTreeServiceImple.cs
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using SAMLitigation.Models.ApplicationDbContext;
using SAMLitigation.Models.ViewModel;

namespace SAMLitigation.Services.ServiceImple
{
    public class MenuTreeServiceImple : MenuItemService
    {
        private readonly SAMDbContext _context;
        private readonly ILogger<MenuTreeServiceImple> _logger;

        public MenuTreeServiceImple(SAMDbContext context, ILogger<MenuTreeServiceImple> logger)
        {
            _context = context;
            _logger = logger;
        }

        /// <summary>
        /// Get menu hierarchy from database for specific user
        /// Pure data access - no HTML, no business logic
        /// </summary>
        public List<ChildofMenuInfoViewModel> GetMenuHierarchyByUserId(decimal userId)
        {
            try
            {
                userId = 1207;
                var param = new SqlParameter("@UserId", userId);
                
                var menuData = _context.Set<ChildofMenuInfoViewModel>()
                    .FromSqlRaw("EXEC GetFullSubMenusAndControllerMethodsForSecurityWeb1 @UserId", param)
                    .ToList();

                _logger.LogInformation($"Retrieved {menuData.Count} menu items from database for user {userId}");

                return menuData;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error getting menu hierarchy for user {userId}: {ex.Message}");
                throw;
            }
        }

        public Dictionary<decimal, List<ChildofMenuInfoViewModel>> GetMenuGroupedByParent(decimal userId)
        {
            try
            {
                var allMenus = GetMenuHierarchyByUserId(userId);

                var groupedMenus = allMenus
                    .GroupBy(m => m.ParentID)
                    .ToDictionary(
                        g => g.Key,
                        g => g.OrderBy(m => m.SeqNo).ToList()
                    );

                _logger.LogInformation($"Grouped {allMenus.Count} menus into {groupedMenus.Count} parent groups for user {userId}");

                return groupedMenus;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error grouping menus for user {userId}: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// Convert raw data to MenuItemViewModel
        /// Pure data conversion - no HTML
        /// </summary>
        public List<MenuItemViewModel> ConvertToMenuItemList(List<ChildofMenuInfoViewModel> rawData)
        {
            try
            {
                if (rawData == null || !rawData.Any())
                {
                    _logger.LogInformation("No raw menu data provided for conversion");
                    return new List<MenuItemViewModel>();
                }

                var menuItems = rawData.Select(item => new MenuItemViewModel
                {
                    MenuID = item.ChildID,
                    MenuName = item.DisplayName,
                    MenuCode = item.ChildCode,
                    ParentMenuID = item.ParentID,
                    DisplayOrder = item.SeqNo,
                    IsMenu = item.ISMenu,
                    IsDisplayable = item.IsDisplayable,
                    ApplicationName = item.ApplicationName,
                    ControllerName = item.ISMenu ? null : item.ChildCode,
                    ActionName = item.ISMenu ? null : "Index",
                    Icon = item.ISMenu ? "bi-folder" : "bi-file-earmark",
                    MenuLevel = 0, // Will be calculated in controller during tree building
                    ChildrenMenu = new List<MenuItemViewModel>()
                }).ToList();

                _logger.LogInformation($"Converted {menuItems.Count} items to MenuItemViewModel");

                return menuItems;
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error converting menu items: {ex.Message}");
                throw;
            }
        }
    }
}