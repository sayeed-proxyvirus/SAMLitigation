@model IEnumerable<SAMLitigation.Models.ViewModel.SAM_Litigation_DetailsViewModel>

@{
    ViewData["Title"] = "Litigation Details";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2>
                <i class="fas fa-gavel"></i> SAM Litigation Details
            </h2>
            <hr />
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12 text-right">
            <button type="button" class="btn btn-primary" onclick="handleAddDocument()">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Litigation Actions List
                    </h5>
                </div>
                <div class="card-body">
                    <div class="litigation-cards-container" id="litigationCardsContainer">
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <div class="litigation-item" data-item-index="@Model.ToList().IndexOf(item)">
                                    @switch (item.PartialViewNumber)
                                    {
                                        case 1:
                                            @await Html.PartialAsync("_SuitFillingIdcolReceivePartialView", item)
                                            break;
                                        case 2:
                                            @await Html.PartialAsync("_SuitFillingReportedToBangladeshBankPartialView", item)
                                            break;
                                        case 3:
                                            @await Html.PartialAsync("_HearingPartialView", item)
                                            break;
                                        case 4:
                                            @await Html.PartialAsync("_DiscussionArgumentPartialView", item)
                                            break;
                                        case 5:
                                            @await Html.PartialAsync("_SuitDismissalPartialView", item)
                                            break;
                                        default:
                                            <div class="alert alert-warning mb-3" role="alert">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>Unknown Category</strong> - PartialViewNumber: @item.PartialViewNumber
                                            </div>
                                            break;
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-info text-center" role="alert">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <h5>No Litigation Actions Found</h5>
                                <p class="mb-0">Click the "Add Details" button above to add a new litigation action.</p>
                            </div>
                        }
                    </div>

                    @if (Model != null && Model.Any())
                    {
                        <div class="pagination-container mt-3">
                            <nav aria-label="Litigation pagination">
                                <ul class="pagination justify-content-center" id="paginationControls">
                                    <!-- Pagination buttons will be generated by JavaScript -->
                                </ul>
                            </nav>
                            <div class="text-center">
                                <small class="text-muted" id="paginationInfo">
                                    <!-- Pagination info will be displayed here -->
                                </small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="fas fa-edit"></i> Edit Litigation Detail
                </h5>
            </div>
            <div class="modal-body">
                <form id="editDetailsForm">
                    <input type="hidden" id="edit_litigationDetailID" />
                    <input type="hidden" id="edit_litigationID" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_litigationActionID">Litigation Action <span class="text-danger">*</span></label>
                                <select id="edit_litigationActionID" class="form-control" required>
                                    <option value="">-- Select Action --</option>
                                    @if (ViewBag.ListActions != null)
                                    {
                                        @foreach (var action in ViewBag.ListActions)
                                        {
                                            <option value="@action.Value">@action.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_actionTakenDate">Action Date <span class="text-danger">*</span></label>
                                <input type="date" id="edit_actionTakenDate" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_caseNumber">Case Number <span class="text-danger">*</span></label>
                                <input type="text" id="edit_caseNumber" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_litigationCourtID">Court Name <span class="text-danger">*</span></label>
                                <select id="edit_litigationCourtID" class="form-control" required>
                                    <option value="">-- Select Court --</option>
                                    @if (ViewBag.ListCourts != null)
                                    {
                                        @foreach (var court in ViewBag.ListCourts)
                                        {
                                            <option value="@court.Value">@court.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_litigationLawyerID">Lawyer Name <span class="text-danger">*</span></label>
                                <select id="edit_litigationLawyerID" class="form-control" required>
                                    <option value="">-- Select Lawyer --</option>
                                    @if (ViewBag.ListLawyers != null)
                                    {
                                        @foreach (var lawyer in ViewBag.ListLawyers)
                                        {
                                            <option value="@lawyer.Value">@lawyer.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_commentsPriorAction">Comments Prior Action</label>
                                <textarea id="edit_commentsPriorAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="edit_commentsPostAction">Comments Post Action</label>
                                <textarea id="edit_commentsPostAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-warning" onclick="handleSaveChanges()">
                    <i class="fas fa-save"></i> Update
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addModalLabel">
                    <i class="fas fa-plus-circle"></i> Add Litigation Detail
                </h5>
            </div>
            <div class="modal-body">
                <form id="addDetailsForm">
                    <input type="hidden" id="litigationID" value="@ViewBag.LitigationId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="litigationActionID">Litigation Action <span class="text-danger">*</span></label>
                                <select id="litigationActionID" class="form-control" required>
                                    <option value="">-- Select Action --</option>
                                    @if (ViewBag.ListActions != null)
                                    {
                                        @foreach (var action in ViewBag.ListActions)
                                        {
                                            <option value="@action.Value">@action.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="actionTakenDate">Action Date <span class="text-danger">*</span></label>
                                <input type="date" id="actionTakenDate" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="caseNumber">Case Number <span class="text-danger">*</span></label>
                                <input type="text" id="caseNumber" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="litigationCourtID">Court Name <span class="text-danger">*</span></label>
                                <select id="litigationCourtID" class="form-control" required>
                                    <option value="">-- Select Court --</option>
                                    @if (ViewBag.ListCourts != null)
                                    {
                                        @foreach (var court in ViewBag.ListCourts)
                                        {
                                            <option value="@court.Value">@court.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="litigationLawyerID">Lawyer Name <span class="text-danger">*</span></label>
                                <select id="litigationLawyerID" class="form-control" required>
                                    <option value="">-- Select Lawyer --</option>
                                    @if (ViewBag.ListLawyers != null)
                                    {
                                        @foreach (var lawyer in ViewBag.ListLawyers)
                                        {
                                            <option value="@lawyer.Value">@lawyer.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="commentsPriorAction">Comments Prior Action</label>
                                <textarea id="commentsPriorAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="commentsPostAction">Comments Post Action</label>
                                <textarea id="commentsPostAction" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseAddModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="handleSaveNewDetail()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table-responsive {
        max-height: 650px;
        overflow-y: auto;
    }

    thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #343a40 !important;
        color: white !important;
    }

    .default-row {
        background-color: #f5f5f5;
    }

    .badge-lg {
        font-size: 0.95em;
    }

    .litigation-cards-container {
        min-height: 400px;
        padding: 0.5rem;
    }

    .litigation-item {
        display: none;
    }

        .litigation-item.active {
            display: block;
        }

    .pagination-container {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .pagination .page-link {
        color: #007bff;
        cursor: pointer;
    }

    .pagination .page-item.disabled .page-link {
        cursor: not-allowed;
    }

    /* Empty state styling */
    .alert-info i.fa-2x {
        display: block;
        margin: 0 auto;
    }
</style>


@section Scripts {
    <script>
        var currentLitigationID = @(ViewBag.LitigationId ?? 0);
        var userRoleId = @(ViewBag.UserRoleId ?? 0);
        var itemsPerPage = 10;
        var currentPage = 1;
        var totalItems = 0;

        // Initialize pagination on page load
        $(document).ready(function() {
            initializePagination();
        });

        function initializePagination() {
            totalItems = $('.litigation-item').length;
            if (totalItems > 0) {
                showPage(1);
                renderPaginationControls();
            }
        }

        function showPage(page) {
            currentPage = page;
            var startIndex = (page - 1) * itemsPerPage;
            var endIndex = startIndex + itemsPerPage;

            // Hide all items
            $('.litigation-item').removeClass('active');

            // Show items for current page
            $('.litigation-item').slice(startIndex, endIndex).addClass('active');

            // Update pagination info
            updatePaginationInfo();
        }

        function renderPaginationControls() {
            var totalPages = Math.ceil(totalItems / itemsPerPage);
            var paginationHtml = '';

            // Previous button
            paginationHtml += '<li class="page-item ' + (currentPage === 1 ? 'disabled' : '') + '">';
            paginationHtml += '<a class="page-link" onclick="changePage(' + (currentPage - 1) + ')" aria-label="Previous">';
            paginationHtml += '<span aria-hidden="true">&laquo;</span>';
            paginationHtml += '</a></li>';

            // Page numbers
            for (var i = 1; i <= totalPages; i++) {
                paginationHtml += '<li class="page-item ' + (i === currentPage ? 'active' : '') + '">';
                paginationHtml += '<a class="page-link" onclick="changePage(' + i + ')">' + i + '</a>';
                paginationHtml += '</li>';
            }

            // Next button
            paginationHtml += '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '">';
            paginationHtml += '<a class="page-link" onclick="changePage(' + (currentPage + 1) + ')" aria-label="Next">';
            paginationHtml += '<span aria-hidden="true">&raquo;</span>';
            paginationHtml += '</a></li>';

            $('#paginationControls').html(paginationHtml);
        }

        function changePage(page) {
            var totalPages = Math.ceil(totalItems / itemsPerPage);

            if (page < 1 || page > totalPages) {
                return;
            }

            showPage(page);
            renderPaginationControls();

            // Scroll to top of cards container
            $('#litigationCardsContainer').get(0).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updatePaginationInfo() {
            var startItem = (currentPage - 1) * itemsPerPage + 1;
            var endItem = Math.min(currentPage * itemsPerPage, totalItems);
            var infoText = 'Showing ' + startItem + ' to ' + endItem + ' of ' + totalItems + ' records';
            $('#paginationInfo').text(infoText);
        }

        // Function to open Add modal
        function handleAddDocument() {
            // Reset the form
            $('#addDetailsForm')[0].reset();
            // Set the litigation ID (it's already in the hidden field from the page load)
            $('#litigationID').val(currentLitigationID);
            // Show the modal
            $('#addModal').modal('show');
        }

        // Function to save new detail
        function handleSaveNewDetail() {
            // Validate the form
            if (!$('#addDetailsForm')[0].checkValidity()) {
                $('#addDetailsForm')[0].reportValidity();
                return;
            }

            var formData = {
                litigationID: parseFloat($('#litigationID').val()),
                litigationActionID: parseFloat($('#litigationActionID').val()),
                actionTakenDate: $('#actionTakenDate').val(),
                caseNumber: $('#caseNumber').val(),
                commentsPriorAction: $('#commentsPriorAction').val(),
                commentsPostAction: $('#commentsPostAction').val(),
                litigationCourtID: parseFloat($('#litigationCourtID').val()),
                litigationLawyerID: parseFloat($('#litigationLawyerID').val()),
                makerUserID: 1, // Default value Login Value
                checkerUserID: 1 // Default value Login Value
            };

            console.log('Adding detail:', formData);

            $.ajax({
                url: '@Url.Action("AddDetails", "SAM_Litigation_Details")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Add response:', response);
                    if (response.success) {
                        alert(response.message);
                        $('#addModal').modal('hide');
                        // Reload with the litigation ID parameter
                        window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + currentLitigationID;
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Add error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }

        // Function to close Add modal
        function handleCloseAddModal() {
            $('#addModal').modal('hide');
        }

        // Function to handle editing a litigation detail
        function handleEditDetail(detailId) {
            console.log('Editing detail ID:', detailId);

            $.ajax({
                url: '@Url.Action("GetDetailById", "SAM_Litigation_Details")',
                type: 'GET',
                data: { id: detailId },
                success: function(response) {
                    console.log('Get response:', response);

                    // Check if response has success property and it's false (error response)
                    if (response.success === false) {
                        alert(response.message || 'Failed to load detail data');
                        return;
                    }

                    // Check if we have the required data
                    if (response.success === true && response.litigationDetailID) {
                        populateEditForm(response);
                        $('#editModal').modal('show');
                    } else {
                        alert('Invalid data received from server');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    alert('An error occurred while loading data: ' + error);
                }
            });
        }

                function populateEditForm(data) {
            console.log('Populating form with:', data);
            $('#edit_litigationDetailID').val(data.litigationDetailID);
            $('#edit_litigationID').val(data.litigationID);
            $('#edit_actionTakenDate').val(data.actionTakenDate);
            $('#edit_caseNumber').val(data.caseNumber);
            $('#edit_commentsPriorAction').val(data.commentsPriorAction || '');
            $('#edit_commentsPostAction').val(data.commentsPostAction || '');

            $('#edit_litigationActionID').val(data.litigationActionID);
            $('#edit_litigationCourtID').val(data.litigationCourtID);
            $('#edit_litigationLawyerID').val(data.litigationLawyerID);
        }

        // Function to handle saving changes to a litigation detail
            function handleSaveChanges() {
            if (!$('#editDetailsForm')[0].checkValidity()) {
                $('#editDetailsForm')[0].reportValidity();
                return;
            }

            var formData = {
                litigationDetailID: parseFloat($('#edit_litigationDetailID').val()),
                litigationID: parseFloat($('#edit_litigationID').val()),
                litigationActionID: parseFloat($('#edit_litigationActionID').val()),
                actionTakenDate: $('#edit_actionTakenDate').val(),
                caseNumber: $('#edit_caseNumber').val(),
                commentsPriorAction: $('#edit_commentsPriorAction').val(),
                commentsPostAction: $('#edit_commentsPostAction').val(),
                litigationCourtID: parseFloat($('#edit_litigationCourtID').val()),
                litigationLawyerID: parseFloat($('#edit_litigationLawyerID').val()),
                makerUserID: 1,
                checkerUserID: 0,
                isVerifying: false
            };

            console.log('Updating detail:', formData);

            $.ajax({
                url: '@Url.Action("UpdateDetails", "SAM_Litigation_Details")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Update response:', response);
                    if (response.success) {
                        alert(response.message);
                        $('#editModal').modal('hide');
                        window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + currentLitigationID;
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Update Error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }
         function handleVerifyDetail(detailId) {
            if (!confirm('Are you sure you want to verify this detail? Once verified, it cannot be edited.')) {
                return;
            }

            console.log('Verifying detail ID:', detailId);

            // Get the detail first
            $.ajax({
                url: '@Url.Action("GetDetailById", "SAM_Litigation_Details")',
                type: 'GET',
                data: { id: detailId },
                success: function(detail) {
                    if (detail.success) {
                        // Now call UpdateDetails with isVerifying = true
                        var formData = {
                            litigationDetailID: detail.litigationDetailID,
                            litigationID: detail.litigationID,
                            litigationActionID: detail.litigationActionID,
                            actionTakenDate: detail.actionTakenDate,
                            caseNumber: detail.caseNumber,
                            commentsPriorAction: detail.commentsPriorAction,
                            commentsPostAction: detail.commentsPostAction,
                            litigationCourtID: detail.litigationCourtID,
                            litigationLawyerID: detail.litigationLawyerID,
                            makerUserID: 1,
                            checkerUserID: 1,
                            isVerifying: true
                        };

                        $.ajax({
                            url: '@Url.Action("UpdateDetails", "SAM_Litigation_Details")',
                            type: 'POST',
                            data: formData,
                            success: function(response) {
                                console.log('Verify response:', response);
                                if (response.success) {
                                    alert(response.message);
                                    window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + currentLitigationID;
                                } else {
                                    alert(response.message);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Verify error:', xhr.responseText);
                                alert('An error occurred: ' + error);
                            }
                        });
                    } else {
                        alert(detail.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Get detail error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }
        // Function to handle closing the modal
        function handleCloseModal() {
            $('#editModal').modal('hide');
        }

        function viewDocument(LitigationDetailID) {
            if(!LitigationDetailID) {
                alert("Invalid Record ID");
                return;
            }
            window.location.href = '@Url.Action("Index", "SAM_Litigation_Detail_DocumentList")' + '?id=' + LitigationDetailID;
        }
    </script>
}