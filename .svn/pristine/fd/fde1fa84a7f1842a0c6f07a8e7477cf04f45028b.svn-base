
using SAMLitigation.Models;
using SAMLitigation.Models.ApplicationDbContext;


namespace SAMLitigation.Services.ServiceImple
{
    public class AuthenticateServiceImple : AuthenticateService
    {
        private readonly SAMDbContext _context;
        //private readonly UserTableService _userTableService;
        private readonly HttpClient _httpClient;

        public AuthenticateServiceImple(SAMDbContext context, HttpClient httpClient)
        {
            _context = context;
           // _userTableService = userTableService;
            _httpClient = httpClient;
        }

       

        public UserTable AuthenticateAsync(string username, string password)
        {
            try 
            {
                string url = $"http://172.16.0.180:8040/api/auth/login?username={username}&password={password}";

                // Set headers
                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("X-API-KEY", "MNReJOAXZ15424352552AXY}{*A[[[;;;;]]]OP@_$!bvcderAOPQASD");
                _httpClient.DefaultRequestHeaders.Add("Accept", "application/json");

                // Send GET request synchronously
                var response = _httpClient.GetAsync(url).Result;

                // API request failed (500/404/etc)
                if (!response.IsSuccessStatusCode)
                    return null;

                // Read string synchronously
                var resultString = response.Content.ReadAsStringAsync().Result;

                // Convert "true" / "false" to bool
                bool isValid = bool.TryParse(resultString, out var parsed) ? parsed : false;

                if (!isValid)
                    return null;

                // Successful login -> get user
                //return _userTableService.GetUserByUsername(username);
                return new UserTable();
            }
            catch
            {
                throw;
            }
        }

        public bool GetControllerMethodPermission (string ControllerName, string MethodName, decimal UserID, bool IsGet)
        {
            try
            {
                //string url = $"http://172.16.0.180:8040/api/auth/userRoles?username={Username}";
                string url = $"http://172.16.0.180:8040//api/auth/accessPermission?controllerName={ControllerName}&methodName={MethodName}&UserID={UserID}&isGet={IsGet}";

                // Set headers
                _httpClient.DefaultRequestHeaders.Clear();
                _httpClient.DefaultRequestHeaders.Add("X-API-KEY", "MNReJOAXZ15424352552AXY}{*A[[[;;;;]]]OP@_$!bvcderAOPQASD");
                _httpClient.DefaultRequestHeaders.Add("Accept", "application/json");

                // Send GET request synchronously
                var response = _httpClient.GetAsync(url).Result;

                if (!response.IsSuccessStatusCode)
                    return false;

                // Read the boolean response from API
                string result = response.Content.ReadAsStringAsync().GetAwaiter().GetResult();

                // Convert "true" / "false" -> bool
                bool isPermitted = bool.TryParse(result, out var parsed) && parsed;

                return isPermitted;


            } 
            catch 
            {
                throw;
            }
        }
    }
}
