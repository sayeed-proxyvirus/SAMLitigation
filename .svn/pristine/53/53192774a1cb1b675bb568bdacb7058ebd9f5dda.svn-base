using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using SAMLitigation.Models;
using SAMLitigation.Models.ViewModel;
using SAMLitigation.Services;
using System.Text.Json;

namespace SAMLitigation.Controllers
{
    public class SAM_Litigation_DetailsController : Controller
    {

        private readonly ILogger<SAM_Litigation_DetailsController> _logger;
        private readonly LitigationDetailService _litigationDetailService;
        private readonly CourtService _courtService;
        private readonly LawyerService _lawyerService;
        private readonly LitigationActionService _litigationActionService;
        private readonly LitigationMasterService _litigationMasterService;

        public SAM_Litigation_DetailsController(ILogger<SAM_Litigation_DetailsController> logger,
            LitigationDetailService litigationDetailService, CourtService courtService,
            LawyerService lawyerService, LitigationActionService litigationActionService,
            LitigationMasterService litigationMasterService)
        {
            _logger = logger;
            _litigationDetailService = litigationDetailService;
            _courtService = courtService;
            _lawyerService = lawyerService;
            _litigationActionService = litigationActionService;
            _litigationMasterService = litigationMasterService;
        }

        [HttpGet]
        public IActionResult Index(decimal Id)
        {
            try
            {
                // Store the litigation ID in ViewBag for the view
                ViewBag.LitigationId = Id;

                // Setup dropdown lists
                List<SAM_Litigation_Court> ListCourt = _courtService.GetCourtALL();
                ViewBag.ListCourts = ListCourt.Select(x => new SelectListItem
                {
                    Value = x.LitigationCourtID.ToString(),
                    Text = x.CourtName
                }).ToList() ?? new List<SelectListItem>();

                List<SAM_Litigation_Lawyer> ListLawyer = _lawyerService.GetLawyerALL();
                ViewBag.ListLawyers = ListLawyer.Select(x => new SelectListItem
                {
                    Value = x.LitigationLawyerID.ToString(),
                    Text = x.LawyerName
                }).ToList() ?? new List<SelectListItem>();

                List<SAM_Litigation_Action> ListAction = _litigationActionService.GetActionALL();
                ViewBag.ListActions = ListAction.Select(x => new SelectListItem
                {
                    Value = x.LitigationActionID.ToString(),
                    Text = x.LitigationActionName
                }).ToList() ?? new List<SelectListItem>();

                _logger.LogInformation($"Fetching details with Litigation ID: {Id}");

                // Get all details for this litigation ID
                // IMPORTANT: Id here is LitigationID, not LitigationDetailID
                var details = _litigationDetailService.GetDetailsALLByLitigationId(Id);

                if (details == null || !details.Any())
                {
                    _logger.LogWarning($"No details found for Litigation ID {Id}");
                    details = new List<SAM_Litigation_DetailsViewModel>();
                }
                else
                {
                    _logger.LogInformation($"Found {details.Count} detail(s) for Litigation ID {Id}");
                }

                // Return the view with the list of details
                return View(details);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in Index: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                // Return empty list on error so the view still renders
                return View(new List<SAM_Litigation_DetailsViewModel>());
            }
        }

        [HttpPost]
        public IActionResult AddDetails(decimal litigationID, decimal litigationActionID,
            DateTime actionTakenDate, string caseNumber, string commentsPriorAction,
            string commentsPostAction, decimal litigationCourtID, decimal litigationLawyerID,
            decimal makerUserID, decimal checkerUserID)
        {
            try
            {
                var Details = new SAM_Litigation_Detail
                {
                    LitigationID = litigationID,
                    LitigationActionID = litigationActionID,
                    ActionTakenDate = actionTakenDate,
                    CommentsPriorAction = commentsPriorAction,
                    CommentsPostAction = commentsPostAction,
                    CaseNumber = caseNumber,
                    CheckerUserID = checkerUserID,
                    MakerUserID = makerUserID,
                    LitigationCourtID = litigationCourtID,
                    LitigationLawyerID = litigationLawyerID
                };

                bool success = _litigationDetailService.Add(Details);
                if (success)
                {
                    _logger.LogInformation($"Litigation detail added successfully for Litigation ID: {litigationID}");
                    return Json(new
                    {
                        success = true,
                        message = $"Litigation detail has been added successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning("Litigation detail addition failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to add litigation detail. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in AddDetails: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpPost]
        public IActionResult UpdateDetails(decimal LitigationDetailID, decimal litigationID,
            decimal litigationActionID, DateTime actionTakenDate, string caseNumber,
            string commentsPriorAction, string commentsPostAction, decimal litigationCourtID,
            decimal litigationLawyerID, decimal makerUserID, decimal checkerUserID)
        {
            try
            {
                //Get Session
                var rolesJson = HttpContext.Session.GetString("roles");
                List<UserRoleRelationViewModel> roles = new List<UserRoleRelationViewModel>();

                if (!string.IsNullOrEmpty(rolesJson))
                {
                     roles = JsonSerializer.Deserialize<List<UserRoleRelationViewModel>>(rolesJson);
                }


                var existingDetail = _litigationDetailService.GetDetailByIdForUpdate(LitigationDetailID);
                if (existingDetail == null)
                {
                    return Json(new
                    {
                        success = false,
                        message = "Detail not found."
                    });
                }

                existingDetail.LitigationID = litigationID;
                existingDetail.LitigationActionID = litigationActionID;
                existingDetail.ActionTakenDate = actionTakenDate;
                existingDetail.CaseNumber = caseNumber;
                existingDetail.CommentsPostAction = commentsPostAction;
                existingDetail.CommentsPriorAction = commentsPriorAction;
                existingDetail.LitigationCourtID = litigationCourtID;
                existingDetail.LitigationLawyerID = litigationLawyerID;
                existingDetail.CheckerUserID = checkerUserID;
                existingDetail.MakerUserID = makerUserID;

                bool success = _litigationDetailService.Update(existingDetail);
                if (success)
                {
                    _logger.LogInformation($"Litigation detail {LitigationDetailID} updated successfully");
                    return Json(new
                    {
                        success = true,
                        message = $"Litigation detail has been updated successfully!"
                    });
                }
                else
                {
                    _logger.LogWarning($"Litigation detail {LitigationDetailID} update failed");
                    return Json(new
                    {
                        success = false,
                        message = "Failed to update litigation detail. Please try again."
                    });
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in UpdateDetails: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }

        [HttpGet]
        public IActionResult GetDetailById(decimal id)
        {
            try
            {
                _logger.LogInformation($"Fetching detail with LitigationDetailID: {id}");

                // Get the detail by LitigationDetailID
                var detailEntity = _litigationDetailService.GetDetailByIdForUpdate(id);

                if (detailEntity == null)
                {
                    _logger.LogWarning($"Detail with LitigationDetailID {id} not found");
                    return Json(new
                    {
                        success = false,
                        message = "Detail not found."
                    });
                }

                // Now get all details for this LitigationID to find the one with names
                var detailList = _litigationDetailService.GetDetailsALLByLitigationId(detailEntity.LitigationID);

                // Find the specific detail from the list by LitigationDetailID
                var detail = detailList?.FirstOrDefault(d => d.LitigationDetailID == id);

                if (detail == null)
                {
                    _logger.LogWarning($"Detail with LitigationDetailID {id} not found in list");
                    return Json(new
                    {
                        success = false,
                        message = "Detail not found."
                    });
                }

                _logger.LogInformation($"Detail with LitigationDetailID {id} retrieved successfully");

                // Return the detail data as JSON
                return Json(new
                {
                    success = true,
                    litigationDetailID = detail.LitigationDetailID,
                    litigationID = detailEntity.LitigationID,
                    litigationActionName = detail.LitigationActionName ?? string.Empty,
                    actionTakenDate = detail.ActionTakenDate.ToString("yyyy-MM-dd"),
                    caseNumber = detail.CaseNumber ?? string.Empty,
                    commentsPriorAction = detail.CommentsPriorAction ?? string.Empty,
                    commentsPostAction = detail.CommentsPostAction ?? string.Empty,
                    courtName = detail.CourtName ?? string.Empty,
                    lawyerName = detail.LawyerName ?? string.Empty
                });
            }
            catch (Exception ex)
            {
                _logger.LogError($"Exception in GetDetailById: {ex.Message}");
                if (ex.InnerException != null)
                {
                    _logger.LogError($"Inner Exception: {ex.InnerException.Message}");
                }
                return Json(new
                {
                    success = false,
                    message = "An error occurred: " + ex.Message
                });
            }
        }
    }
}