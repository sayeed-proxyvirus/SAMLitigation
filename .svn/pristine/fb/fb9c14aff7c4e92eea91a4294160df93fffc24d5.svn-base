@model SAMLitigation.Models.SAM_Litigation_Master
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Litigation Entry Management";
}

<!-- Page Header -->
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2>
                <i class="fas fa-gavel"></i> Litigation Entry Management
            </h2>
            <hr />
        </div>
    </div>

    <!--  DataTable Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Litigation List</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="handleAddLitigation()">
                <i class="fas fa-plus"></i> Add New Litigation
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="masterTable" class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th class="d-none">Litigation ID</th>
                            <th>Project</th>
                            <th>Initial Case No</th>
                            <th>Litigation Type</th>
                            <th>Litigation Cause</th>
                            <th>Litigation Status</th>
                            <th>Complainant</th>
                            <th>Defendent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Litigation Modal -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addModalLabel">
                    <i class="bi bi-file-earmark-plus me-2"></i>Add New Litigation
                </h5>
            </div>
            <div class="modal-body">
                <form id="addLitigationForm">
                    <div class="row">
                        <!-- Project -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Project <span class="text-danger">*</span></label>
                                <select id="ProjectID" name="ProjectID" class="form-control" required>
                                    <option value="">-- Select Project --</option>
                                    @if (ViewBag.ProjectList != null)
                                    {
                                        @foreach (var project in ViewBag.ProjectList)
                                        {
                                            <option value="@project.Value">@project.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Litigation Type -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Litigation Type <span class="text-danger">*</span></label>
                                <select id="LitigationTypeID" name="LitigationTypeID" class="form-control" required>
                                    <option value="">-- Select Type --</option>
                                    @if (ViewBag.LitigationTypeList != null)
                                    {
                                        @foreach (var type in ViewBag.LitigationTypeList)
                                        {
                                            <option value="@type.Value">@type.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Status <span class="text-danger">*</span></label>
                                <select id="LitigationStatusId" name="LitigationStatusId" class="form-control" required>
                                    <option value="">-- Select Status --</option>
                                    @if (ViewBag.StatusList != null)
                                    {
                                        @foreach (var status in ViewBag.StatusList)
                                        {
                                            <option value="@status.Value">@status.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Cause -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Litigation Cause <span class="text-danger">*</span></label>
                                <select id="LitigationCauseID" name="LitigationCauseID" class="form-control" required>
                                    <option value="">-- Select Cause --</option>
                                    @if (ViewBag.CauseList != null)
                                    {
                                        @foreach (var cause in ViewBag.CauseList)
                                        {
                                            <option value="@cause.Value">@cause.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Complainant -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Complainant <span class="text-danger">*</span></label>
                                <select id="ComplainantLitigationPartyID" name="ComplainantLitigationPartyID" class="form-control" required>
                                    <option value="">-- Select Complainant --</option>
                                    @if (ViewBag.PartyList != null)
                                    {
                                        @foreach (var party in ViewBag.PartyList)
                                        {
                                            <option value="@party.Value">@party.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Defendant -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Defendant <span class="text-danger">*</span></label>
                                <select id="DefendentLitigationPartyID" name="DefendentLitigationPartyID" class="form-control" required>
                                    <option value="">-- Select Defendant --</option>
                                    @if (ViewBag.PartyList != null)
                                    {
                                        @foreach (var party in ViewBag.PartyList)
                                        {
                                            <option value="@party.Value">@party.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Case Number -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Initial Case Number</label>
                                <input type="text" id="InitialCaseNumber" name="InitialCaseNumber" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>

                        <!-- Is Against IDCOL -->
                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check">
                                <input type="checkbox" id="IsAgainstIDCOL" name="IsAgainstIDCOL" class="form-check-input" />
                                <label class="form-check-label" for="IsAgainstIDCOL">
                                    Is Against IDCOL
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseAddModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="handleSaveNewLitigation()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Litigation Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Litigation
                </h5>
            </div>
            <div class="modal-body">
                <form id="editLitigationForm">
                    <input type="hidden" id="edit_LitigationID" />

                    <div class="row">
                        <!-- Project -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Project <span class="text-danger">*</span></label>
                                <select id="edit_ProjectID" class="form-control" required>
                                    <option value="">-- Select Project --</option>
                                    @if (ViewBag.ProjectList != null)
                                    {
                                        @foreach (var project in ViewBag.ProjectList)
                                        {
                                            <option value="@project.Value">@project.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Litigation Type -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Litigation Type <span class="text-danger">*</span></label>
                                <select id="edit_LitigationTypeID" class="form-control" required>
                                    <option value="">-- Select Type --</option>
                                    @if (ViewBag.LitigationTypeList != null)
                                    {
                                        @foreach (var type in ViewBag.LitigationTypeList)
                                        {
                                            <option value="@type.Value">@type.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Status <span class="text-danger">*</span></label>
                                <select id="edit_LitigationStatusId" class="form-control" required>
                                    <option value="">-- Select Status --</option>
                                    @if (ViewBag.StatusList != null)
                                    {
                                        @foreach (var status in ViewBag.StatusList)
                                        {
                                            <option value="@status.Value">@status.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Cause -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Litigation Cause <span class="text-danger">*</span></label>
                                <select id="edit_LitigationCauseID" class="form-control" required>
                                    <option value="">-- Select Cause --</option>
                                    @if (ViewBag.CauseList != null)
                                    {
                                        @foreach (var cause in ViewBag.CauseList)
                                        {
                                            <option value="@cause.Value">@cause.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Complainant -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Complainant <span class="text-danger">*</span></label>
                                <select id="edit_ComplainantLitigationPartyID" class="form-control" required>
                                    <option value="">-- Select Complainant --</option>
                                    @if (ViewBag.PartyList != null)
                                    {
                                        @foreach (var party in ViewBag.PartyList)
                                        {
                                            <option value="@party.Value">@party.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Defendant -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Defendant <span class="text-danger">*</span></label>
                                <select id="edit_DefendentLitigationPartyID" class="form-control" required>
                                    <option value="">-- Select Defendant --</option>
                                    @if (ViewBag.PartyList != null)
                                    {
                                        @foreach (var party in ViewBag.PartyList)
                                        {
                                            <option value="@party.Value">@party.Text</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Case Number -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Initial Case Number</label>
                                <input type="text" id="edit_InitialCaseNumber" class="form-control" placeholder="Enter case number" />
                            </div>
                        </div>

                        <!-- Is Against IDCOL -->
                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check">
                                <input type="checkbox" id="edit_IsAgainstIDCOL" class="form-check-input" />
                                <label class="form-check-label" for="edit_IsAgainstIDCOL">
                                    Is Against IDCOL
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="handleCloseEditModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-warning" onclick="handleUpdateLitigation()">
                    <i class="fas fa-save"></i> Update
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
            // Load litigations on page load
            loadLitigations();

            // Prevent selecting same party as complainant & defendant in Add modal
            $("#ComplainantLitigationPartyID").on("change", function () {
                if ($(this).val() && $(this).val() === $("#DefendentLitigationPartyID").val()) {
                    alert("Complainant and Defendant cannot be the same.");
                    $(this).val("");
                }
            });

            $("#DefendentLitigationPartyID").on("change", function () {
                if ($(this).val() && $("#ComplainantLitigationPartyID").val() === $(this).val()) {
                    alert("Complainant and Defendant cannot be the same.");
                    $(this).val("");
                }
            });

            // Prevent selecting same party as complainant & defendant in Edit modal
            $("#edit_ComplainantLitigationPartyID").on("change", function () {
                if ($(this).val() && $(this).val() === $("#edit_DefendentLitigationPartyID").val()) {
                    alert("Complainant and Defendant cannot be the same.");
                    $(this).val("");
                }
            });

            $("#edit_DefendentLitigationPartyID").on("change", function () {
                if ($(this).val() && $("#edit_ComplainantLitigationPartyID").val() === $(this).val()) {
                    alert("Complainant and Defendant cannot be the same.");
                    $(this).val("");
                }
            });
        });

        // Load litigation list from server-side ViewBag
        function loadLitigations() {
            var litigationList = @Html.Raw(Json.Serialize(ViewBag.LitigationList ?? new List<object>()));
            console.log('Loaded', litigationList.length, 'litigations');
            populateLitigationTable(litigationList);
        }

        // Populate litigation table
        function populateLitigationTable(litigationList) {
            console.log('Populating table with', litigationList.length, 'entries');
            var tbody = $('#masterTable tbody');
            tbody.empty();

            if (litigationList.length === 0) {
                tbody.append('<tr><td colspan="9" class="text-center text-muted">No records found</td></tr>');
                return;
            }

            $.each(litigationList, function(index, item) {
                var row = `
                    <tr>
                        <td class="d-none">${item.litigationID || ''}</td>
                        <td>${escapeHtml(item.projectName || '')}</td>
                        <td>${escapeHtml(item.initialCaseNumber || '')}</td>
                        <td>${escapeHtml(item.litigationTypeName || '')}</td>
                        <td>${escapeHtml(item.causeName || '')}</td>
                        <td>${escapeHtml(item.litigationStatusName || '')}</td>
                        <td>${escapeHtml(item.complainant || '')}</td>
                        <td>${escapeHtml(item.defendant || '')}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning me-1"
                                    onclick="handleEditLitigation('${item.litigationID}')"
                                    title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-info"
                                    onclick="viewDetails('${item.litigationID}')"
                                    title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            console.log('Table populated successfully');

            // Initialize or reinitialize DataTable
            if ($.fn.DataTable.isDataTable('#masterTable')) {
                $('#masterTable').DataTable().destroy();
            }

            $('#masterTable').DataTable({
                "pageLength": 10,
                "order": [[0, "asc"]],
                "searching": true,
                "lengthChange": false,
                "language": {
                    "emptyTable": "No litigations found"
                }
            });
        }

        // Escape HTML (security)
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Open Add modal
        function handleAddLitigation() {
            $('#addLitigationForm')[0].reset();
            $('#addModal').modal('show');
        }

        // Close Add modal
        function handleCloseAddModal() {
            $('#addModal').modal('hide');
        }

        // Save new litigation
        function handleSaveNewLitigation() {
            if (!$('#addLitigationForm')[0].checkValidity()) {
                $('#addLitigationForm')[0].reportValidity();
                return;
            }

            var formData = {
                ProjectID: parseInt($('#ProjectID').val()),
                LitigationTypeID: parseInt($('#LitigationTypeID').val()),
                LitigationStatusId: parseInt($('#LitigationStatusId').val()),
                LitigationCauseID: parseInt($('#LitigationCauseID').val()),
                ComplainantLitigationPartyID: parseInt($('#ComplainantLitigationPartyID').val()),
                DefendentLitigationPartyID: parseInt($('#DefendentLitigationPartyID').val()),
                InitialCaseNumber: $('#InitialCaseNumber').val(),
                IsAgainstIDCOL: $('#IsAgainstIDCOL').is(':checked')
            };

            console.log('Adding litigation:', formData);

            $.ajax({
                url: '@Url.Action("Index", "SAM_Litigation_Master")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    alert('Litigation added successfully');
                    $('#addModal').modal('hide');
                    window.location.reload();
                },
                error: function(xhr, status, error) {
                    console.error('Add error:', xhr.responseText);
                    alert('An error occurred: ' + error);
                }
            });
        }

        // Open Edit modal
        function handleEditLitigation(litigationId) {
            if (!litigationId) {
                alert("Invalid litigation ID");
                return;
            }

            console.log('Editing litigation ID:', litigationId);

            $.ajax({
                url: '@Url.Action("GetByIdForUpdate", "SAM_Litigation_Master")',
                type: 'GET',
                data: { id: litigationId },
                success: function(response) {
                    console.log('Get response:', response);

                    // Check if response has success property and it's false
                    if (response && response.success === false) {
                        alert(response.message || 'Failed to load litigation data');
                        return;
                    }

                    // Check if we have valid data
                    if (response && response.litigationID) {
                        populateEditForm(response);
                        $('#editModal').modal('show');
                    } else {
                        alert('Invalid data received from server');
                        console.error('Invalid response:', response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error Details:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });
                    alert('An error occurred while loading data. Please check console for details.');
                }
            });
        }

        // Populate edit form
        function populateEditForm(data) {
            console.log('Populating edit form with:', data);

            // Use the exact property names from your response
            $('#edit_LitigationID').val(data.litigationID || data.LitigationID);
            $('#edit_ProjectID').val(data.projectID || data.ProjectID);
            $('#edit_LitigationTypeID').val(data.litigationTypeID || data.LitigationTypeID);
            $('#edit_LitigationStatusId').val(data.litigationStatusId || data.LitigationStatusId);
            $('#edit_LitigationCauseID').val(data.litigationCauseID || data.LitigationCauseID);
            $('#edit_ComplainantLitigationPartyID').val(data.complainantLitigationPartyID || data.ComplainantLitigationPartyID);
            $('#edit_DefendentLitigationPartyID').val(data.defendentLitigationPartyID || data.DefendentLitigationPartyID);
            $('#edit_InitialCaseNumber').val(data.initialCaseNumber || data.InitialCaseNumber || '');
            $('#edit_IsAgainstIDCOL').prop('checked', data.isAgainstIDCOL || data.IsAgainstIDCOL || false);

            console.log('Form populated successfully');
        }

        // Close Edit modal
        function handleCloseEditModal() {
            $('#editModal').modal('hide');
        }

        // Update litigation
        function handleUpdateLitigation() {
            if (!$('#editLitigationForm')[0].checkValidity()) {
                $('#editLitigationForm')[0].reportValidity();
                return;
            }

            var formData = {
                LitigationID: parseInt($('#edit_LitigationID').val()),
                ProjectID: parseInt($('#edit_ProjectID').val()),
                LitigationTypeID: parseInt($('#edit_LitigationTypeID').val()),
                LitigationStatusId: parseInt($('#edit_LitigationStatusId').val()),
                LitigationCauseID: parseInt($('#edit_LitigationCauseID').val()),
                ComplainantLitigationPartyID: parseInt($('#edit_ComplainantLitigationPartyID').val()),
                DefendentLitigationPartyID: parseInt($('#edit_DefendentLitigationPartyID').val()),
                InitialCaseNumber: $('#edit_InitialCaseNumber').val(),
                IsAgainstIDCOL: $('#edit_IsAgainstIDCOL').is(':checked')
            };

            console.log('Updating litigation with data:', formData);

            $.ajax({
                url: '@Url.Action("UpdateLitigation", "SAM_Litigation_Master")',
                type: 'POST',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: formData,
                success: function(response) {
                    console.log('Update response:', response);
                    if (response.success) {
                        alert(response.message || 'Litigation updated successfully');
                        $('#editModal').modal('hide');
                        window.location.reload();
                    } else {
                        alert(response.message || 'Failed to update litigation');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Update Error Details:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });
                    alert('An error occurred while updating. Please check console for details.');
                }
            });
        }

        // View details
        function viewDetails(litigationID) {
            if (!litigationID) {
                alert("Invalid record ID.");
                return;
            }
            window.location.href = '@Url.Action("Index", "SAM_Litigation_Details")' + '?id=' + litigationID;
        }
    </script>
}

<style>
    .card {
        border: none;
        border-radius: 8px;
    }

    .card-header {
        border-radius: 8px 8px 0 0 !important;
        padding: 1rem 1.5rem;
    }

    .table-responsive {
        border-radius: 4px;
        max-height: 650px;
        overflow-y: auto;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
    }

    .btn {
        border-radius: 4px;
    }

    .modal-content {
        border-radius: 8px;
    }

    .modal-header {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #343a40 !important;
        color: white !important;
    }
</style>